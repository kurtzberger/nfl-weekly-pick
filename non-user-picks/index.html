<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0">
    <meta name="description" content="Weekly Pick 'em">
    <meta name="author" content="Eric Kurtzberg">
    <title>Non-Users' Picks</title>
    <!--Import Google Icon Font and Custom Icons-->
	<link href="https://rawgit.com/Templarian/MaterialDesign-Webfont/master/css/materialdesignicons.min.css" media="all" rel="stylesheet" type="text/css">
    <!--Import materialize.css-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.6/css/materialize.min.css" media="screen,projection">
	<link rel="stylesheet" type="text/css" href="../css/main.css">
</head>
<body>
	<div id="header"></div>
	
	<!--Import jQuery before materialize.js-->
	<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
	<!-- Compiled and minified JavaScript -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.6/js/materialize.min.js"></script>
	<!--Firebase import-->
	<script src="https://www.gstatic.com/firebasejs/live/3.0/firebase.js"></script>
	<script type="text/javascript" src="../js/init.js"></script>
	<script type="text/javascript" src="../js/links.js"></script>
	<script type="text/javascript" src="../js/functions.js"></script>
	<script type="text/javascript" src="../js/WeekGames.js"></script>
	
	<div id="main-content" class="container">
		<div class="show-me" style="display: none">
			<div class="row" style="margin: 2% auto; width: 100px;">
				<p id="current-week"></p>
			</div>
			<div class="row">
				<a id="random-button" class="btn waves-effect waves-light blue-grey lighten-1 btn-large col s6 push-s3">Make Random Picks</a>
			</div>
			<div class="row">
				<a id="home-button" class="btn waves-effect waves-light blue-grey lighten-1 btn-large col s6 push-s3">Make Home Picks</a>
			</div>
			<div class="row">
				<a id="away-button" class="btn waves-effect waves-light blue-grey lighten-1 btn-large col s6 push-s3">Make Away Picks</a>
			</div>
		</div>
	</div>

	<script>
		// Get a reference to the database service
		var database = firebase.database();
		var weekData = null;

		$(document).ready(function () {
			var url = 'http://www.nfl.com/liveupdate/scorestrip/ss.xml';
			$.get(url, function (xml) {
				// create weekly data object from XML file imported
				weekData = new WeekGames(xml, function () {
					$("#header").load("../header.html", function () {
						$('#non-user-link').addClass("deep-orange lighten-3");
						$("#headerTitle").text("Non-Users' Picks");
						$('#current-week').text('Week ' + weekData.week);
						//$('.show-me').toggle();
					});
				});
			});
		});

		$("#main-content").on('click', '#random-button', function () {
			var Points, Picks;
			var path = weekData.season + '/picks/week' + weekData.week;
			var user = 'placeholder@1_com';	// random teams email
			
			// get the api key from the database
			database.ref('api-keys/random').once('value').then(function (snapshot) {
				// json structure to request random array of points from Random.org
				var requestPoints = {
					jsonrpc: "2.0",
					method: "generateIntegers",
					params: {
						apiKey: snapshot.val(),
						n: weekData.games.length,
						min: 1,
						max: weekData.games.length,
						replacement: false	// unique values only
					},
					id: 1
				};
				// json structure to request random array of picks (0=home 1=away) from Random.org
				var requestPicks = {
					jsonrpc: "2.0",
					method: "generateIntegers",
					params: {
						apiKey: snapshot.val(),
						n: weekData.games.length,
						min: 0,
						max: 1
					},
					id: 1
				};
					
				// request points from random.org
				$.post('https://api.random.org/json-rpc/1/invoke', JSON.stringify(requestPoints), function (pointsResult) {
					Points = pointsResult.result.random.data;
					$.post('https://api.random.org/json-rpc/1/invoke', JSON.stringify(requestPicks), function (picksResult) {
						Picks = picksResult.result.random.data;
						for (var i=0; i<weekData.games.length; i++) {
							database.ref(path + '/' + weekData.games[i].id + '/' + user).update({
								game:	i,
								pick:	(Picks[i]===0)
									? weekData.games[i].homeTeam.abbrName
									: weekData.games[i].awayTeam.abbrName,
								points:	Points[i]
							}).catch(function (error) {
								Materialize.toast('Submission failed ' + error.message, 6000, "red darken-1"); // 6000 is the duration of the toast in milliseconds
								return;
							});
						}
						alert('Random Pick: Week ' + weekData.week + ' picks submitted!');
					}, "json");
				}, "json");	
			});
		});

		$("#main-content").on('click', '#home-button', function () {
			var points = (weekData.games.length * (weekData.games.length + 1)) / (2 * weekData.games.length);
			var path = weekData.season + '/picks/week' + weekData.week;
			var user = 'placeholder@2_com';	// home teams email
			for (var i=0; i<weekData.games.length; i++) {
				database.ref(path + '/' + weekData.games[i].id + '/' + user).update({
					game:	i,
					pick:	weekData.games[i].homeTeam.abbrName,
					points:	points
				}).catch(function (error) {
					Materialize.toast('Submission failed ' + error.message, 6000, "red darken-1"); // 6000 is the duration of the toast in milliseconds
					return;
				});
			}
			alert('Home Teams: Week ' + weekData.week + ' picks submitted!');
		});

		$("#main-content").on('click', '#away-button', function () {
			var points = (weekData.games.length * (weekData.games.length + 1)) / (2 * weekData.games.length);
			var path = weekData.season + '/picks/week' + weekData.week;
			var user = 'placeholder@3_com';	// away teams email
			for (var i=0; i<weekData.games.length; i++) {
				database.ref(path + '/' + weekData.games[i].id + '/' + user).update({
					game:	i,
					pick:	weekData.games[i].awayTeam.abbrName,
					points:	points
				}).catch(function (error) {
					Materialize.toast('Submission failed ' + error.message, 6000, "red darken-1"); // 6000 is the duration of the toast in milliseconds
					return;
				});
			}
			alert('Away Teams: Week ' + weekData.week + ' picks submitted!');
		});
	</script>
</body>
</html>
